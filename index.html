<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PurrDnD Studio ‚Äî 2000s Catcore Map & Character Builder</title>

<!-- Pixel / 2000s vibe font -->
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Montserrat:wght@300;600&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0b0010;
    --panel:#0f0b1a;
    --accent1:#ff5be1;
    --accent2:#00f0ff;
    --muted:#bdb6cf;
    --glass: rgba(255,255,255,0.03);
    --neon: 0 0 12px rgba(255,91,225,0.35), 0 0 24px rgba(0,240,255,0.12);
  }

  /* 2000s layout + cat vibe */
  html,body{height:100%;margin:0;background:
    radial-gradient(circle at 10% 10%, rgba(0,240,255,0.06), transparent 10%),
    linear-gradient(120deg,#050012 0%, #0b0010 40%, #1a0022 100%);
    color:var(--muted);
    font-family: Montserrat, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    -webkit-font-smoothing:antialiased;
  }

  header{
    display:flex;align-items:center;gap:12px;padding:12px 18px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00));
    box-shadow: var(--neon);
  }
  .logo {
    display:flex;align-items:center;gap:10px;
  }
  .logo .cat {
    font-family: 'Press Start 2P', monospace;
    color:var(--accent1); font-size:18px; letter-spacing:1px;
    text-shadow: 0 0 8px rgba(255,91,225,0.5);
  }
  h1{margin:0;font-size:14px;color:var(--accent2); font-family: 'Press Start 2P', monospace;}

  main{display:grid;grid-template-columns: 280px 1fr 320px;gap:12px;padding:14px;height:calc(100% - 76px);box-sizing:border-box;}

  /* panels */
  .panel {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:10px;padding:12px;box-shadow: 0 6px 30px rgba(0,0,0,0.6);
    border:1px solid rgba(255,255,255,0.03);
    overflow:auto;
  }

  /* Left tool panel */
  .tools h2{font-size:12px;margin:8px 0;color:var(--accent1);font-family:'Press Start 2P', monospace;}
  .tools .btn {display:block;padding:8px;border-radius:8px;margin:6px 0;background:var(--glass);border:1px solid rgba(255,255,255,0.03);cursor:pointer;color:var(--muted);text-align:left;}
  .tools .btn.selected{box-shadow: var(--neon);border-color:var(--accent2);color:white;}
  .tools label{display:block;margin-top:8px;font-size:12px;color:#a9a0be;}

  /* Canvas area */
  .canvas-wrap{display:flex;flex-direction:column;align-items:stretch;gap:8px;}
  .canvas-top {display:flex;gap:8px;align-items:center;justify-content:space-between;}
  .canvas-frame {
    position:relative;border-radius:8px;overflow:hidden;height:100%;
    min-height:560px;background:
      linear-gradient(0deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px dashed rgba(255,255,255,0.03);
  }
  canvas#map {
    width:100%;height:100%;display:block; background: repeating-linear-gradient(45deg, rgba(255,255,255,0.01) 0 1px, transparent 1px 10px);
    cursor:crosshair; image-rendering: pixelated;
  }

  /* Right panel: Characters + dice */
  .char-list .char-item{display:flex;align-items:center;gap:8px;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px;margin-bottom:8px;}
  .char-list .char-name{font-weight:700;color:#fff}
  .controls-row{display:flex;gap:8px;flex-wrap:wrap}

  /* inputs */
  input, select, textarea{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:6px;color:var(--muted);outline:none}
  input:focus, select:focus, textarea:focus{border-color:var(--accent2);box-shadow:var(--neon);color:#fff}
  button.action{background:linear-gradient(90deg,var(--accent1),var(--accent2));border:none;padding:10px 12px;border-radius:8px;color:#050005;cursor:pointer;font-weight:700;box-shadow:var(--neon)}

  footer{padding:8px 18px;font-size:12px;color:#8f86a1;border-top:1px solid rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center}
  .small{font-size:11px;color:#9b92ad}

  /* 2000s pixel decorations */
  .badge {font-family:'Press Start 2P', monospace;padding:6px 8px;border-radius:6px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);display:inline-block;color:var(--accent1)}
  .tile-preview{width:28px;height:28px;border-radius:4px;border:1px solid rgba(255,255,255,0.04);display:inline-block;}

  /* responsive */
  @media (max-width:980px){
    main{grid-template-columns: 1fr; grid-auto-flow: row;}
    .canvas-frame{min-height:360px}
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="cat">‡∏Ö^‚Ä¢Ôªå‚Ä¢^‡∏Ö</div>
    <div>
      <h1>PurrDnD Studio</h1>
      <div class="small">2000s Catcore Map & Character Builder</div>
    </div>
  </div>

  <div style="margin-left:auto;display:flex;gap:10px;align-items:center">
    <div class="badge">beta v1.0</div>
    <button id="saveAllBtn" class="btn" style="padding:8px 12px">Save Locally üíæ</button>
    <button id="exportBtn" class="btn" style="padding:8px 12px">Export JSON</button>
    <input id="importFile" type="file" accept=".json" style="display:none"/>
    <button id="importBtn" class="btn" style="padding:8px 12px">Import JSON</button>
  </div>
</header>

<main>
  <!-- LEFT: Tools -->
  <aside class="panel tools" id="leftPanel">
    <h2>Map Tools</h2>
    <div id="toolList">
      <button class="btn selected" data-tool="paint">Brush üñåÔ∏è</button>
      <button class="btn" data-tool="erase">Erase üßΩ</button>
      <button class="btn" data-tool="token">Place Token üéØ</button>
      <button class="btn" data-tool="select">Select / Move ‚úã</button>
    </div>

    <label>Brush Color</label>
    <input id="colorPicker" type="color" value="#2b2bff" />

    <label>Tile Fill Mode</label>
    <select id="fillMode">
      <option value="cell">Fill Cells (grid)</option>
      <option value="pixel">Pixel (free draw)</option>
    </select>

    <label>Grid Size (px)</label>
    <input id="gridSize" type="number" min="8" max="128" value="32" />

    <label>Map Dimensions (cells)</label>
    <div style="display:flex;gap:6px">
      <input id="mapCols" type="number" min="8" value="20" style="width:50%" />
      <input id="mapRows" type="number" min="8" value="14" style="width:50%" />
    </div>

    <div style="margin-top:8px" class="controls-row">
      <button class="action" id="resizeMapBtn">Resize Map</button>
      <button class="btn" id="clearMapBtn">Clear</button>
    </div>

    <hr style="opacity:0.06;margin:12px 0"/>

    <h2>Tokens</h2>
    <label>Token Color</label>
    <input id="tokenColor" type="color" value="#ffb86b"/>
    <label>Token Label</label>
    <input id="tokenLabel" type="text" placeholder="e.g., Goblin" />
    <div style="margin-top:8px" class="controls-row">
      <button class="action" id="addTokenBtn">Add Token</button>
      <button class="btn" id="clearTokensBtn">Clear Tokens</button>
    </div>

    <hr style="opacity:0.06;margin:12px 0"/>

    <h2>View</h2>
    <label>Zoom</label>
    <input id="zoomRange" type="range" min="0.5" max="2.4" value="1" step="0.1" />
    <div style="margin-top:8px" class="controls-row">
      <button class="btn" id="toggleGridBtn">Toggle Grid</button>
      <button class="btn" id="snapBtn">Snap to Grid</button>
    </div>

    <hr style="opacity:0.06;margin:12px 0"/>

    <h2>Extras</h2>
    <label>Auto-save</label>
    <select id="autosaveSelect">
      <option value="off">Off</option>
      <option value="5">Every 5s</option>
      <option value="30">Every 30s</option>
      <option value="120">Every 2m</option>
    </select>

    <label>Theme</label>
    <select id="themeSelect">
      <option value="catcore">Catcore Neon</option>
      <option value="classic">Classic 2000s</option>
    </select>

    <div style="height:18px"></div>
    <div class="small">Tip: Press <kbd>Shift</kbd> to draw straight lines. Use <kbd>Ctrl/Cmd</kbd> + Click to pick a color.</div>
  </aside>

  <!-- CENTER: Map -->
  <section class="panel canvas-wrap">
    <div class="canvas-top">
      <div>
        <div class="small">Map:</div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="badge" id="mapInfo">20 √ó 14 cells ‚Ä¢ 32px</div>
          <div class="small" id="mapName">Untitled Cat Map</div>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button id="exportMapPNG" class="btn">Export PNG</button>
        <button id="toggleFogBtn" class="btn">Fog of War</button>
      </div>
    </div>

    <div class="canvas-frame" id="canvasFrame">
      <canvas id="map"></canvas>
    </div>

    <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
      <div class="small">Tool Info:</div>
      <div id="toolInfo" class="small">Brush: paint cells</div>
      <div style="margin-left:auto" class="small">Saved: <span id="lastSaved">never</span></div>
    </div>
  </section>

  <!-- RIGHT: Characters, Dice, Notes -->
  <aside class="panel" id="rightPanel">
    <h2>Character Builder üêæ</h2>

    <div style="display:flex;gap:8px">
      <input id="newCharName" placeholder="New character name" />
      <button id="createCharBtn" class="action">Create</button>
    </div>

    <div class="char-list" id="charList" style="margin-top:10px"></div>

    <hr style="opacity:0.06;margin:12px 0"/>

    <h2>Selected Character</h2>
    <div id="charEditor" style="display:none">
      <label>Name</label><input id="char_name" />
      <label>Race / Class / Level</label>
      <div style="display:flex;gap:6px">
        <input id="char_race" placeholder="Race" />
        <input id="char_class" placeholder="Class" />
        <input id="char_level" type="number" min="1" value="1" style="width:70px" />
      </div>

      <label>HP / AC</label>
      <div style="display:flex;gap:6px">
        <input id="char_hp" type="number" value="10" />
        <input id="char_ac" type="number" value="10" />
      </div>

      <label>Stats</label>
      <div style="display:flex;gap:6px">
        <input id="stat_str" placeholder="STR" />
        <input id="stat_dex" placeholder="DEX" />
        <input id="stat_con" placeholder="CON" />
        <input id="stat_int" placeholder="INT" />
        <input id="stat_wis" placeholder="WIS" />
        <input id="stat_cha" placeholder="CHA" />
      </div>

      <label>Inventory (one per line)</label>
      <textarea id="char_inv" rows="4"></textarea>

      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="saveCharBtn" class="action">Save Character</button>
        <button id="deleteCharBtn" class="btn">Delete</button>
      </div>
    </div>

    <hr style="opacity:0.06;margin:12px 0"/>

    <h2>Dice Roller üé≤</h2>
    <div style="display:flex;gap:8px">
      <input id="diceExpr" placeholder="e.g., 2d6+3 or d20+5" />
      <button id="rollBtn" class="action">Roll</button>
    </div>
    <div id="diceLog" style="margin-top:8px;max-height:120px;overflow:auto;background:rgba(0,0,0,0.2);padding:8px;border-radius:8px"></div>

    <hr style="opacity:0.06;margin:12px 0"/>

    <h2>Initiative Tracker</h2>
    <div style="display:flex;gap:8px">
      <input id="initName" placeholder="Name" />
      <button id="addInitBtn" class="action">Add</button>
    </div>
    <div id="initList" style="margin-top:8px"></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="sortInitBtn" class="btn">Sort</button>
      <button id="clearInitBtn" class="btn">Clear</button>
    </div>

    <hr style="opacity:0.06;margin:12px 0"/>

    <h2>Notes / Chat</h2>
    <textarea id="chatInput" rows="3" placeholder="Type note or chat message..."></textarea>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="postNoteBtn" class="action">Post</button>
      <button id="clearNotesBtn" class="btn">Clear</button>
    </div>
    <div id="notes" style="margin-top:8px;max-height:160px;overflow:auto;background:rgba(0,0,0,0.12);padding:8px;border-radius:8px"></div>
  </aside>
</main>

<footer>
  <div>Made with catnip & nostalgia üêæ</div>
  <div class="small">Tip: Export JSON to save progress; open in Replit and press Run on <strong>main.html</strong>.</div>
</footer>

<script>
/* ========= PurrDnD Studio ‚Äî Single-file JS =========
   Features implemented:
   - Canvas-based grid map paint and tokens
   - Token creation, placement, move
   - Zoom & pan (basic)
   - Character builder with save/load/localStorage
   - Dice roller (XdY+Z parser)
   - Initiative tracker
   - Export/Import JSON for full project
   - Export PNG (map snapshot)
   - Auto-save
   - Lots of UI niceties and 2000s neon look
*/

// ---------- State ----------
const state = {
  cols: 20, rows: 14, gridSize: 32,
  map: [], // cell colors or null
  tokens: [], // {id,x,y,label,color}
  zoom: 1, panX:0, panY:0, showGrid:true, snap:true, fog:false,
  selectedTool: 'paint', brushColor: '#2b2bff',
  selectedTokenColor: '#ffb86b',
  chars: [], selectedCharId: null,
  notes: [],
  lastSaved: null
};

// ---------- Helpers ----------
const $ = id => document.getElementById(id);
const randId = (p='tk') => p + Math.random().toString(36).slice(2,9);
const nowStr = ()=> new Date().toLocaleString();

// ---------- Canvas + Map ----------
const canvas = $('map');
const ctx = canvas.getContext('2d', {alpha:true});
const frame = $('canvasFrame');

function initMap(cols, rows, gridSize){
  state.cols = cols; state.rows = rows; state.gridSize = gridSize;
  state.map = new Array(cols*rows).fill(null);
  state.tokens = [];
  renderMapInfo();
  fitCanvas();
  draw();
}

function resizeMapTo(cols, rows){
  // preserve existing into new map, top-left anchored
  const newMap = new Array(cols*rows).fill(null);
  for(let r=0;r<Math.min(rows,state.rows);r++){
    for(let c=0;c<Math.min(cols,state.cols);c++){
      newMap[r*cols + c] = state.map[r*state.cols + c];
    }
  }
  state.cols = cols; state.rows = rows; state.map = newMap;
  renderMapInfo(); fitCanvas(); draw();
}

function fitCanvas(){
  const pixelWidth = Math.max(400, state.cols * state.gridSize * state.zoom);
  const pixelHeight = Math.max(240, state.rows * state.gridSize * state.zoom);
  canvas.width = state.cols * state.gridSize * Math.ceil(state.zoom*1) ;
  canvas.height = state.rows * state.gridSize * Math.ceil(state.zoom*1) ;
  // style dimensions fill container
  canvas.style.width = (state.cols * state.gridSize * state.zoom) + 'px';
  canvas.style.height = (state.rows * state.gridSize * state.zoom) + 'px';
}

function renderMapInfo(){
  $('mapInfo').textContent = `${state.cols} √ó ${state.rows} cells ‚Ä¢ ${state.gridSize}px`;
  $('mapName').textContent = (state.mapName || 'Untitled Cat Map');
}

// draw grid & cells & tokens
function draw(){
  // clear
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // scale for crispness
  const scale = state.zoom;
  ctx.save();
  ctx.scale(scale,scale);

  // draw cells
  for(let r=0;r<state.rows;r++){
    for(let c=0;c<state.cols;c++){
      const idx = r*state.cols + c;
      const val = state.map[idx];
      const x = c*state.gridSize, y = r*state.gridSize;
      if(val){
        ctx.fillStyle = val;
        ctx.fillRect(x+1, y+1, state.gridSize-2, state.gridSize-2);
      }
    }
  }

  // optional grid lines
  if(state.showGrid){
    ctx.strokeStyle = 'rgba(255,255,255,0.03)';
    ctx.lineWidth = 1;
    for(let c=0;c<=state.cols;c++){
      ctx.beginPath(); ctx.moveTo(c*state.gridSize+0.5,0); ctx.lineTo(c*state.gridSize+0.5,state.rows*state.gridSize); ctx.stroke();
    }
    for(let r=0;r<=state.rows;r++){
      ctx.beginPath(); ctx.moveTo(0,r*state.gridSize+0.5); ctx.lineTo(state.cols*state.gridSize,r*state.gridSize+0.5); ctx.stroke();
    }
  }

  // tokens
  for(const tk of state.tokens){
    const tx = tk.x*state.gridSize + state.gridSize/2;
    const ty = tk.y*state.gridSize + state.gridSize/2;
    // ring
    ctx.beginPath();
    ctx.fillStyle = tk.color || '#ffb86b';
    ctx.arc(tx,ty, state.gridSize*0.36, 0, Math.PI*2);
    ctx.fill();
    // label
    ctx.fillStyle = '#100013';
    ctx.font = `${Math.max(10, state.gridSize/4)}px monospace`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(tk.label || '', tx, ty);
    // outline
    ctx.strokeStyle = 'rgba(0,0,0,0.3)';
    ctx.lineWidth = 2;
    ctx.stroke();
  }

  // fog overlay
  if(state.fog){
    ctx.fillStyle = 'rgba(0,0,0,0.6)';
    ctx.fillRect(0,0,state.cols*state.gridSize,state.rows*state.gridSize);
    // reveal tokens with circular holes
    for(const tk of state.tokens){
      const tx = tk.x*state.gridSize + state.gridSize/2;
      const ty = tk.y*state.gridSize + state.gridSize/2;
      ctx.save();
      ctx.globalCompositeOperation = 'destination-out';
      ctx.beginPath(); ctx.arc(tx,ty,state.gridSize*1.2,0,Math.PI*2); ctx.fill();
      ctx.restore();
    }
  }

  ctx.restore();
  $('lastSaved').textContent = state.lastSaved ? state.lastSaved : 'never';
}

// get cell from page coords
function pageToCell(px, py){
  const rect = canvas.getBoundingClientRect();
  const cx = (px - rect.left) / state.zoom;
  const cy = (py - rect.top) / state.zoom;
  const col = Math.floor(cx / state.gridSize);
  const row = Math.floor(cy / state.gridSize);
  return {col,row};
}

// ---------- Tools interactions ----------
let isDown=false; let lastCell=null; let shiftLineStart=null;

canvas.addEventListener('pointerdown', e=>{
  isDown=true; canvas.setPointerCapture(e.pointerId);
  const {col,row} = pageToCell(e.clientX, e.clientY);
  if(state.selectedTool === 'paint'){ paintCell(col,row); lastCell={col,row}; if(e.shiftKey) shiftLineStart = {col,row}; }
  if(state.selectedTool === 'erase'){ eraseCell(col,row); lastCell={col,row}; if(e.shiftKey) shiftLineStart = {col,row};}
  if(state.selectedTool === 'token'){ placeToken(col,row); }
  draw();
});
canvas.addEventListener('pointermove', e=>{
  if(!isDown) return;
  const {col,row} = pageToCell(e.clientX, e.clientY);
  if(state.selectedTool === 'paint'){ if(shiftLineStart && e.shiftKey) drawLine(shiftLineStart, {col,row}, paintCell); else if(!lastCell || lastCell.col!==col || lastCell.row!==row){ paintCell(col,row); lastCell={col,row}; } }
  if(state.selectedTool === 'erase'){ if(shiftLineStart && e.shiftKey) drawLine(shiftLineStart, {col,row}, eraseCell); else if(!lastCell || lastCell.col!==col || lastCell.row!==row){ eraseCell(col,row); lastCell={col,row}; } }
  draw();
});
canvas.addEventListener('pointerup', e=>{
  isDown=false; canvas.releasePointerCapture(e.pointerId); lastCell=null; shiftLineStart=null; saveIfAuto();
});

function paintCell(c,r){
  if(c<0 || r<0 || c>=state.cols || r>=state.rows) return;
  const idx = r*state.cols + c;
  state.map[idx] = state.brushColor;
}
function eraseCell(c,r){
  if(c<0 || r<0 || c>=state.cols || r>=state.rows) return;
  const idx = r*state.cols + c;
  state.map[idx] = null;
}
function placeToken(c,r){
  if(c<0 || r<0 || c>=state.cols || r>=state.rows) return;
  const id = randId('tk');
  state.tokens.push({id,x:c,y:r,label: $('tokenLabel').value || 'T', color: $('tokenColor').value || '#ffb86b'});
  draw(); saveIfAuto();
}
function drawLine(a,b,fn){
  // Bresenham-like simple
  const dx = Math.abs(b.col - a.col), dy = Math.abs(b.row - a.row);
  const sx = a.col < b.col ? 1 : -1;
  const sy = a.row < b.row ? 1 : -1;
  let err = dx - dy;
  let x = a.col, y = a.row;
  while(true){
    fn(x,y);
    if(x === b.col && y === b.row) break;
    const e2 = 2*err;
    if(e2 > -dy){ err -= dy; x += sx; }
    if(e2 < dx){ err += dx; y += sy; }
  }
}

// select left panel tools
document.querySelectorAll('#toolList .btn').forEach(btn=>{
  btn.onclick = ()=> {
    document.querySelectorAll('#toolList .btn').forEach(b=>b.classList.remove('selected'));
    btn.classList.add('selected'); state.selectedTool = btn.dataset.tool; $('toolInfo').textContent = toolInfoText(state.selectedTool);
  };
});

function toolInfoText(t){
  switch(t){
    case 'paint': return 'Brush: paint cells (Shift to draw straight lines)';
    case 'erase': return 'Erase cells';
    case 'token': return 'Click to place token';
    case 'select': return 'Select / Move tokens (drag)';
    default: return '';
  }
}

// tilesize, map size controls
$('gridSize').addEventListener('change', e=>{
  state.gridSize = Number(e.target.value); fitCanvas(); draw();
});
$('mapCols').addEventListener('change', e=>{/* nothing immediate */});
$('mapRows').addEventListener('change', e=>{/* nothing immediate */});
$('resizeMapBtn').addEventListener('click', ()=>{
  const cols = Math.max(4, Number($('mapCols').value));
  const rows = Math.max(4, Number($('mapRows').value));
  resizeMapTo(cols, rows);
});

// color picker
$('colorPicker').addEventListener('input', e=> state.brushColor = e.target.value);
$('tokenColor').addEventListener('input', e=> state.selectedTokenColor = e.target.value);

// tokens UI
$('addTokenBtn').addEventListener('click', ()=>{
  // place at center
  const cx = Math.floor(state.cols/2), cy = Math.floor(state.rows/2);
  state.tokens.push({id:randId('tk'), x:cx, y:cy, label:$('tokenLabel').value || 'T', color:$('tokenColor').value});
  draw(); saveIfAuto();
});
$('clearTokensBtn').addEventListener('click', ()=>{ state.tokens=[]; draw(); saveIfAuto(); });

// grid toggle & snap
$('toggleGridBtn').addEventListener('click', ()=>{ state.showGrid = !state.showGrid; draw(); });
$('snapBtn').addEventListener('click', ()=>{ state.snap = !state.snap; alert('Snap toggled: '+state.snap); });

// zoom
$('zoomRange').addEventListener('input', e=>{ state.zoom = Number(e.target.value); fitCanvas(); draw(); });

// clear map
$('clearMapBtn').addEventListener('click', ()=>{ if(confirm('Clear whole map?')){ state.map.fill(null); state.tokens=[]; draw(); saveIfAuto(); } });

// fog toggle
$('toggleFogBtn').addEventListener('click', ()=>{ state.fog = !state.fog; draw(); });

// export PNG
$('exportMapPNG').addEventListener('click', ()=>{
  // create image from canvas at native resolution
  const link = document.createElement('a');
  link.download = (state.mapName || 'purrmap') + '.png';
  // draw final at full resolution
  const tmp = document.createElement('canvas'); tmp.width = state.cols*state.gridSize; tmp.height = state.rows*state.gridSize;
  const tctx = tmp.getContext('2d');
  // paint white bg then draw map scaled 1:1
  // draw cells
  for(let r=0;r<state.rows;r++){
    for(let c=0;c<state.cols;c++){
      const idx = r*state.cols + c; const val = state.map[idx];
      if(val){ tctx.fillStyle = val; tctx.fillRect(c*state.gridSize+1,r*state.gridSize+1,state.gridSize-2,state.gridSize-2); }
    }
  }
  // tokens
  for(const tk of state.tokens){
    const tx = tk.x*state.gridSize + state.gridSize/2;
    const ty = tk.y*state.gridSize + state.gridSize/2;
    tctx.beginPath(); tctx.fillStyle = tk.color; tctx.arc(tx,ty,state.gridSize*0.36,0,Math.PI*2); tctx.fill();
    tctx.fillStyle = '#100013'; tctx.font = `${Math.max(10, state.gridSize/4)}px monospace`; tctx.textAlign='center'; tctx.textBaseline='middle'; tctx.fillText(tk.label||'',tx,ty);
    tctx.strokeStyle = 'rgba(0,0,0,0.3)'; tctx.lineWidth=2; tctx.stroke();
  }
  link.href = tmp.toDataURL('image/png'); link.click();
});

// ---------- Characters ----------
function loadStateFromStorage(){
  try {
    const raw = localStorage.getItem('purrdnd_v1');
    if(raw){
      const parsed = JSON.parse(raw);
      Object.assign(state, parsed);
      state.map = parsed.map || state.map;
      state.tokens = parsed.tokens || state.tokens;
      state.chars = parsed.chars || [];
      state.notes = parsed.notes || [];
      state.lastSaved = parsed.lastSaved || null;
    }
  } catch(e){ console.warn('load fail', e); }
}

function saveStateToStorage(){
  try {
    const toSave = {
      cols: state.cols, rows: state.rows, gridSize: state.gridSize,
      map: state.map, tokens: state.tokens, chars: state.chars, notes: state.notes,
      lastSaved: nowStr(), mapName: state.mapName
    };
    localStorage.setItem('purrdnd_v1', JSON.stringify(toSave));
    state.lastSaved = toSave.lastSaved;
    $('lastSaved').textContent = state.lastSaved;
  } catch(e){ console.warn('save fail', e); }
}

$('saveAllBtn').addEventListener('click', ()=>{ saveStateToStorage(); alert('Saved locally!') });

$('exportBtn').addEventListener('click', ()=>{
  const data = exportProject();
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.download = (state.mapName || 'purrdnd') + '.json';
  a.href = URL.createObjectURL(blob); a.click();
});

$('importBtn').addEventListener('click', ()=> $('importFile').click());
$('importFile').addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const j = JSON.parse(reader.result);
      importProject(j);
      alert('Imported project!');
    } catch(err){ alert('Invalid JSON'); }
  };
  reader.readAsText(f);
});

function exportProject(){
  return {
    meta: {exportedAt: new Date().toISOString(), name: state.mapName || 'purrdnd'},
    cols: state.cols, rows: state.rows, gridSize: state.gridSize,
    map: state.map, tokens: state.tokens, chars: state.chars, notes: state.notes
  };
}

function importProject(j){
  state.cols = j.cols || state.cols;
  state.rows = j.rows || state.rows;
  state.gridSize = j.gridSize || state.gridSize;
  state.map = j.map || state.map;
  state.tokens = j.tokens || [];
  state.chars = j.chars || [];
  state.notes = j.notes || [];
  fitCanvas(); draw(); renderCharList(); renderNotes();
}

// ---------- Characters UI ----------
$('createCharBtn').addEventListener('click', ()=>{
  const name = $('newCharName').value.trim();
  if(!name) return alert('Give your kitty a name!');
  const ch = {id:randId('ch'), name, race:'', class:'', level:1, hp:10, ac:10, stats:{}, inv:[]};
  state.chars.push(ch); $('newCharName').value=''; renderCharList(); saveIfAuto();
});
function renderCharList(){
  const el = $('charList'); el.innerHTML='';
  for(const c of state.chars){
    const div = document.createElement('div'); div.className='char-item';
    const avatar = document.createElement('div'); avatar.style.width='40px'; avatar.style.height='40px'; avatar.style.borderRadius='6px';
    avatar.style.background = 'linear-gradient(90deg,'+randomPastel(c.name||'a')+', rgba(0,0,0,0.06))';
    avatar.style.display='flex';avatar.style.alignItems='center';avatar.style.justifyContent='center'; avatar.style.fontWeight='700'; avatar.textContent = (c.name||'C').slice(0,1);
    const name = document.createElement('div'); name.innerHTML=`<div class="char-name">${c.name}</div><div class="small">${c.race||''} ${c.class||''}</div>`;
    const open = document.createElement('button'); open.className='btn'; open.textContent='Open'; open.onclick = ()=> openCharEditor(c.id);
    div.appendChild(avatar); div.appendChild(name); div.appendChild(open);
    el.appendChild(div);
  }
}

function randomPastel(seed){
  // deterministic-ish pastel
  let s = 0; for(let ch of (seed||'x')) s += ch.charCodeAt(0);
  const r = (s*37)%255, g=(s*17)%255, b=(s*83)%255;
  return `rgba(${r},${g},${b},0.9)`;
}

function openCharEditor(id){
  const ch = state.chars.find(x=>x.id===id); if(!ch) return;
  state.selectedCharId = id;
  $('charEditor').style.display='block';
  $('char_name').value = ch.name;
  $('char_race').value = ch.race || '';
  $('char_class').value = ch.class || '';
  $('char_level').value = ch.level || 1;
  $('char_hp').value = ch.hp || 0; $('char_ac').value = ch.ac || 0;
  $('stat_str').value = ch.stats.str || '';
  $('stat_dex').value = ch.stats.dex || '';
  $('stat_con').value = ch.stats.con || '';
  $('stat_int').value = ch.stats.int || '';
  $('stat_wis').value = ch.stats.wis || '';
  $('stat_cha').value = ch.stats.cha || '';
  $('char_inv').value = (ch.inv || []).join('\\n');
}

$('saveCharBtn').addEventListener('click', ()=>{
  const id = state.selectedCharId; if(!id) return;
  const ch = state.chars.find(x=>x.id===id); if(!ch) return;
  ch.name = $('char_name').value; ch.race = $('char_race').value; ch.class = $('char_class').value; ch.level = Number($('char_level').value||1);
  ch.hp = Number($('char_hp').value||0); ch.ac = Number($('char_ac').value||0);
  ch.stats = {str:$('stat_str').value, dex:$('stat_dex').value, con:$('stat_con').value, int:$('stat_int').value, wis:$('stat_wis').value, cha:$('stat_cha').value};
  ch.inv = $('char_inv').value.split('\\n').map(s=>s.trim()).filter(s=>s);
  renderCharList(); saveIfAuto(); alert('Saved!');
});

$('deleteCharBtn').addEventListener('click', ()=>{
  if(!state.selectedCharId) return;
  if(!confirm('Delete this character?')) return;
  state.chars = state.chars.filter(c=>c.id !== state.selectedCharId);
  state.selectedCharId = null; $('charEditor').style.display='none';
  renderCharList(); saveIfAuto();
});

// ---------- Dice roller ----------
function rollDice(expr){
  expr = expr.replace(/\s+/g,'').toLowerCase();
  // simple parser: support + and - and NdM
  try {
    const parts = expr.split(/(?=[+-])/); // keep signs
    let total = 0; let breakdown=[];
    for(const part of parts){
      if(part === '') continue;
      if(/^[+-]/.test(part)){
        // keep sign in part
      }
      if(/d/.test(part)){
        // e.g., +2d6-3 etc maybe multiple dice
        const sign = part[0]==='-' ? -1 : 1;
        const core = part.replace(/^[+-]/,'');
        const [nRaw,mRaw] = core.split('d');
        const n = nRaw===''?1:parseInt(nRaw);
        const m = parseInt(mRaw);
        let sum = 0; let rolls=[];
        for(let i=0;i<n;i++){ const r = Math.floor(Math.random()*m)+1; rolls.push(r); sum += r; }
        total += sign * sum;
        breakdown.push((sign<0?'-':'')+`${n}d${m}(${rolls.join(',')})`);
      } else {
        // flat number
        const v = parseInt(part);
        if(!isNaN(v)){ total += v; breakdown.push(part); }
      }
    }
    return {total, breakdown};
  } catch(err){ return {error: 'Parse error'}; }
}

$('rollBtn').addEventListener('click', ()=>{
  const expr = $('diceExpr').value.trim() || '1d20';
  const res = rollDice(expr);
  const el = document.createElement('div');
  if(res.error){ el.textContent = `Error: ${res.error}`; } else {
    el.innerHTML = `<strong>${expr}</strong> ‚Üí <span style="color:#fff">${res.total}</span><div class="small">${res.breakdown.join(' + ')}</div>`;
  }
  $('diceLog').prepend(el); // show latest on top
});

// ---------- Initiative ----------
$('addInitBtn').addEventListener('click', ()=>{
  const name = $('initName').value.trim(); if(!name) return;
  const roll = rollDice('1d20').total + 0;
  const id = randId('i');
  const li = {id,name,roll,timestamp:Date.now()};
  state.init = state.init || []; state.init.push(li);
  renderInit(); $('initName').value=''; saveIfAuto();
});
function renderInit(){
  const el = $('initList'); el.innerHTML='';
  (state.init||[]).forEach(it=>{
    const d = document.createElement('div'); d.style.display='flex'; d.style.justifyContent='space-between'; d.style.padding='6px'; d.style.borderRadius='6px'; d.style.marginBottom='6px';
    d.style.background = 'rgba(255,255,255,0.02)';
    d.innerHTML = `<div style="font-weight:700">${it.name}</div><div style="font-family:monospace">${it.roll}</div>`;
    el.appendChild(d);
  });
}
$('sortInitBtn').addEventListener('click', ()=>{ state.init = (state.init||[]).sort((a,b)=>b.roll - a.roll); renderInit(); });
$('clearInitBtn').addEventListener('click', ()=>{ state.init=[]; renderInit(); saveIfAuto(); });

// ---------- Notes / Chat ----------
$('postNoteBtn').addEventListener('click', ()=>{
  const t = $('chatInput').value.trim(); if(!t) return;
  state.notes.unshift({id:randId('n'), text:t, created:nowStr()});
  $('chatInput').value=''; renderNotes(); saveIfAuto();
});
$('clearNotesBtn').addEventListener('click', ()=>{ if(confirm('Clear notes?')){ state.notes=[]; renderNotes(); saveIfAuto(); }});
function renderNotes(){
  const el = $('notes'); el.innerHTML='';
  for(const n of state.notes){ const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px dashed rgba(255,255,255,0.02)'; d.innerHTML = `<div class="small">${n.created}</div><div>${n.text}</div>`; el.appendChild(d); }
}

// ---------- Export/Import project handled above ----------

// ---------- Autosave ----------
let autosaveTimer = null;
$('autosaveSelect').addEventListener('change', ()=>{
  const v = $('autosaveSelect').value;
  if(autosaveTimer) { clearInterval(autosaveTimer); autosaveTimer = null; }
  if(v !== 'off'){ autosaveTimer = setInterval(()=> saveStateToStorage(), Number(v)*1000); }
});
function saveIfAuto(){ const v = $('autosaveSelect').value; if(v !== 'off'){ saveStateToStorage(); }}

// ---------- Load on start ----------
(function boot(){
  // initialize map defaults
  initMap(state.cols, state.rows, state.gridSize);
  // try to load saved state
  loadStateFromStorage();
  renderMapInfo();
  fitCanvas();
  draw();
  renderCharList();
  renderNotes();
  renderInit();
})();

// ---------- Small extra features ----------
$('clearMapBtn').addEventListener('dblclick', ()=>{ if(confirm('Hard clear (wipe everything including tokens)?')){ state.map = new Array(state.cols*state.rows).fill(null); state.tokens = []; draw(); saveIfAuto(); }});

// theme select (just cosmetic toggles)
$('themeSelect').addEventListener('change', e=>{
  const t = e.target.value;
  if(t==='classic'){
    document.documentElement.style.setProperty('--accent1','#00e5ff');
    document.documentElement.style.setProperty('--accent2','#ff8bd6');
  } else {
    document.documentElement.style.setProperty('--accent1','#ff5be1');
    document.documentElement.style.setProperty('--accent2','#00f0ff');
  }
});

// save / export functions used by footer
function saveQuick(){
  saveStateToStorage();
}

// random quick load for testing
window.purr = {
  save: saveStateToStorage,
  export: ()=> { const a = $('exportBtn'); a.click(); },
  clearAll: ()=> { if(confirm('Clear everything?')){ state.map.fill(null); state.tokens=[]; state.chars=[]; state.notes=[]; saveIfAuto(); draw(); renderCharList(); renderNotes(); } }
};

// import from earlier state if available
loadStateFromStorage();
renderCharList(); renderNotes(); draw();
</script>
