<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Kitty World Fixed</title>
<style>
  html, body {
    margin: 0; padding: 0;
    width: 100%; height: 100%;
    overflow: hidden;
    background: #b7eaff;
    touch-action: none;
    font-family: "Poppins", sans-serif;
  }

  #game {
    position: relative;
    width: 100vw; height: 100vh;
    background: url('place_meadow.png') center/cover no-repeat;
  }

  #kitty {
    position: absolute;
    width: 128px; height: 128px;
    background: url('kitty_stand.png') center/contain no-repeat;
    image-rendering: pixelated;
    transition: transform 0.05s linear;
  }

  #nameTag {
    position: absolute;
    top: -25px;
    width: 128px;
    text-align: center;
    color: white;
    font-weight: bold;
    text-shadow: 1px 1px 4px #000;
    font-size: 16px;
  }

  #joystick {
    position: absolute;
    bottom: 30px; left: 30px;
    width: 140px; height: 140px;
    border-radius: 50%;
    background: rgba(255,255,255,0.15);
    border: 2px solid rgba(255,255,255,0.4);
    touch-action: none;
  }

  #knob {
    position: absolute;
    width: 60px; height: 60px;
    top: 40px; left: 40px;
    border-radius: 50%;
    background: rgba(255,255,255,0.9);
  }
</style>
</head>
<body>

<div id="game">
  <div id="kitty">
    <div id="nameTag"></div>
  </div>
  <div id="joystick"><div id="knob"></div></div>
</div>

<script>
  const kitty = document.getElementById("kitty");
  const nameTag = document.getElementById("nameTag");
  const joystick = document.getElementById("joystick");
  const knob = document.getElementById("knob");

  let username = prompt("Enter your username:") || "Kitty";
  nameTag.textContent = username;

  let pos = { x: window.innerWidth / 2, y: window.innerHeight / 2 };
  let vel = { x: 0, y: 0 };
  let joy = { active: false, startX: 0, startY: 0, x: 0, y: 0 };

  const speed = 3;
  let frame = 0;
  let dir = "front";
  let lastFrameChange = 0;

  function update() {
    pos.x += vel.x;
    pos.y += vel.y;

    // keep kitty on screen (fixes disappearing issue)
    pos.x = Math.max(0, Math.min(window.innerWidth - 128, pos.x));
    pos.y = Math.max(0, Math.min(window.innerHeight - 128, pos.y));

    kitty.style.left = pos.x + "px";
    kitty.style.top = pos.y + "px";

    const now = performance.now();

    if (vel.x === 0 && vel.y === 0) {
      kitty.style.backgroundImage = "url('kitty_stand.png')";
    } else if (now - lastFrameChange > 150) { // slow frame change to remove flicker
      frame = (frame + 1) % 2;
      lastFrameChange = now;

      if (dir === "front")
        kitty.style.backgroundImage = `url('kitty_walk_front${frame + 1}.png')`;
      else if (dir === "back")
        kitty.style.backgroundImage = `url('kitty_walk_back${frame + 1}.png')`;
      else if (dir === "side")
        kitty.style.backgroundImage = `url('kitty_walk_side${frame + 1}.png')`;
    }

    nameTag.style.left = "0px";
    nameTag.style.top = "-25px";

    requestAnimationFrame(update);
  }

  // Joystick touch controls
  joystick.addEventListener("touchstart", e => {
    joy.active = true;
    const t = e.touches[0];
    joy.startX = t.clientX;
    joy.startY = t.clientY;
  });

  joystick.addEventListener("touchmove", e => {
    if (!joy.active) return;
    const t = e.touches[0];
    const dx = t.clientX - joy.startX;
    const dy = t.clientY - joy.startY;

    const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 50);
    const angle = Math.atan2(dy, dx);

    joy.x = Math.cos(angle) * dist;
    joy.y = Math.sin(angle) * dist;

    knob.style.left = 40 + joy.x + "px";
    knob.style.top = 40 + joy.y + "px";

    vel.x = (joy.x / 50) * speed;
    vel.y = (joy.y / 50) * speed;

    // direction logic
    if (Math.abs(vel.x) > Math.abs(vel.y)) {
      dir = "side";
      kitty.style.transform = vel.x < 0 ? "scaleX(-1)" : "scaleX(1)";
    } else {
      if (vel.y > 0) dir = "front";
      else dir = "back";
    }
  });

  joystick.addEventListener("touchend", () => {
    joy.active = false;
    vel.x = vel.y = 0;
    knob.style.left = "40px";
    knob.style.top = "40px";
  });

  // Optional: keyboard for PC test
  const keys = {};
  window.addEventListener("keydown", e => keys[e.key] = true);
  window.addEventListener("keyup", e => keys[e.key] = false);

  function handleKeys() {
    vel.x = vel.y = 0;
    if (keys.ArrowUp || keys.w) { vel.y = -speed; dir = "back"; }
    if (keys.ArrowDown || keys.s) { vel.y = speed; dir = "front"; }
    if (keys.ArrowLeft || keys.a) { vel.x = -speed; dir = "side"; kitty.style.transform = "scaleX(-1)"; }
    if (keys.ArrowRight || keys.d) { vel.x = speed; dir = "side"; kitty.style.transform = "scaleX(1)"; }
    requestAnimationFrame(handleKeys);
  }

  handleKeys();
  update();
</script>
</body>
</html>
