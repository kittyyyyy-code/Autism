<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Library Kitty — DnD Studio</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0b0b; --panel:#121212; --accent:#d11a1a; --accent-2:#f3c72b; --muted:#cfcfcf;
    --glass: rgba(255,255,255,0.03);
    --radius:12px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--muted);
    background:linear-gradient(180deg,#070707,#0f0f0f);-webkit-font-smoothing:antialiased}
  header{display:flex;gap:12px;align-items:center;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.03)}
  .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(180deg,var(--accent),#900);display:flex;align-items:center;justify-content:center;font-weight:700;color:black}
  h1{margin:0;font-size:18px;font-weight:700;color:var(--accent)}
  .subtitle{font-size:12px;color:var(--muted)}
  .top-controls{margin-left:auto;display:flex;gap:8px;align-items:center}
  button,select,input,textarea{background:var(--glass);color:var(--muted);border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:8px}
  button.primary{background:linear-gradient(180deg,var(--accent),#9b0a0a);color:#fff;font-weight:700}
  button.yellow{background:linear-gradient(180deg,var(--accent-2),#e0b02b);color:#000}
  .layout{display:grid;grid-template-columns:320px 1fr 360px;gap:16px;padding:16px;height:calc(100vh - 72px)}
  .panel{background:var(--panel);padding:12px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.03);overflow:auto}
  .panel h3{margin:0 0 8px 0;color:var(--accent);font-size:14px}
  /* Left: characters + tools */
  .char-list{display:flex;flex-direction:column;gap:8px}
  .char-item{display:flex;gap:10px;align-items:center;padding:8px;border-radius:8px;cursor:pointer}
  .char-item.active{background:rgba(209,26,26,0.06);border:1px solid rgba(209,26,26,0.14)}
  .avatar{width:44px;height:44;border-radius:8px;background:#220000;display:flex;align-items:center;justify-content:center;color:var(--accent-2);font-weight:700}
  .char-meta{flex:1}
  .small{font-size:13px;color:var(--muted)}
  label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
  input[type="number"]{width:100%}
  textarea{width:100%;min-height:80px;border-radius:8px;padding:8px}
  .row{display:flex;gap:8px}
  .row .col{flex:1}
  /* Center: map area */
  .map-toolbar{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .map-canvas{background:linear-gradient(180deg,#0b0b0b,#111);padding:12px;border-radius:8px;display:flex;justify-content:center;align-items:center}
  .grid{background:#111;border-radius:6px;overflow:auto;display:inline-block}
  .tile{width:48px;height:48px;border:1px solid rgba(255,255,255,0.03);display:inline-flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;user-select:none}
  .tile.alt{background:#141414}
  .tile.token-present{outline:3px solid rgba(243,199,43,0.14)}
  .map-settings{display:flex;gap:8px;align-items:center}
  /* Right: tokens, initiative, dice */
  .token-list{display:flex;flex-direction:column;gap:8px}
  .token-item{display:flex;gap:8px;align-items:center;padding:8px;border-radius:8px}
  .initiative{display:flex;flex-direction:column;gap:8px}
  .initiative-list{display:flex;flex-direction:column;gap:6px}
  .initiative-item{display:flex;justify-content:space-between;gap:8px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)}
  .dice{display:flex;gap:6px;align-items:center}
  .footer-hint{font-size:12px;color:#999;margin-top:8px}
  /* small screens */
  @media (max-width:1100px){.layout{grid-template-columns:1fr;grid-auto-rows:min-content;height:auto;padding-bottom:40px}}
</style>
</head>
<body>

<header>
  <div class="logo">LK</div>
  <div>
    <h1>Library Kitty — DnD Studio</h1>
    <div class="subtitle">Local campaign manager — characters, maps, tokens, initiative</div>
  </div>

  <div class="top-controls">
    <button id="exportCampaign" class="yellow">Export Campaign</button>
    <input id="importFile" type="file" accept=".json" style="display:none">
    <button id="importCampaign">Import Campaign</button>
    <button id="clearAll">Reset</button>
  </div>
</header>

<div class="layout">
  <!-- LEFT: Characters & Tools -->
  <aside class="panel">
    <h3>Characters</h3>
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <button id="newChar" class="primary">+ New Character</button>
      <button id="importChar">Import</button>
    </div>

    <div id="charList" class="char-list" aria-live="polite"></div>

    <hr style="border:none;height:1px;background:rgba(255,255,255,0.02);margin:12px 0">

    <div id="charEditor" style="display:none">
      <h3>Edit Character</h3>
      <label>Name <input id="charName" type="text"></label>
      <label>Avatar (emoji or letter) <input id="charAvatar" type="text" maxlength="2"></label>

      <div class="row">
        <div class="col">
          <label>HP <input id="charHP" type="number" min="0"></label>
        </div>
        <div class="col">
          <label>AC <input id="charAC" type="number" min="0"></label>
        </div>
      </div>

      <label>Stats (comma separated STR,DEX,CON,INT,WIS,CHA)
        <input id="charStats" type="text" placeholder="10,14,12,8,13,11">
      </label>

      <label>Notes
        <textarea id="charNotes" placeholder="Backstory, spells, equipment..."></textarea>
      </label>

      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="saveChar" class="primary">Save</button>
        <button id="deleteChar">Delete</button>
        <button id="exportChar">Export Char</button>
      </div>
    </div>
  </aside>

  <!-- CENTER: Map & Canvas -->
  <section class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h3>Map Editor</h3>
        <div class="small">Create a grid map, paint tiles, place tokens, and export map data.</div>
      </div>

      <div class="map-settings">
        <label>W <input id="mapW" type="number" value="12" min="4" style="width:64px"></label>
        <label>H <input id="mapH" type="number" value="8" min="4" style="width:64px"></label>
        <button id="resizeMap">Resize</button>
        <label>Tile style
          <select id="paintMode">
            <option value="floor">Floor</option>
            <option value="wall">Wall</option>
            <option value="water">Water</option>
            <option value="erase">Erase</option>
          </select>
        </label>
        <button id="undoPaint">Undo</button>
      </div>
    </div>

    <div class="map-toolbar" style="margin-top:12px">
      <div class="small">Token tools:</div>
      <select id="tokenPicker"></select>
      <button id="addTokenBtn">Add Token</button>
      <button id="createTokenBtn">Create Token</button>

      <div style="margin-left:auto;display:flex;gap:8px">
        <button id="exportMap">Export Map</button>
        <button id="importMap">Import Map</button>
        <input id="importMapFile" type="file" accept=".json" style="display:none">
      </div>
    </div>

    <div class="map-canvas" style="margin-top:12px">
      <div id="gridWrap" class="grid" tabindex="0" aria-label="Map grid"></div>
    </div>
  </section>

  <!-- RIGHT: Tokens, Initiative, Dice -->
  <aside class="panel">
    <h3>Token Library</h3>
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <button id="newToken">+ New Token</button>
      <button id="exportTokens">Export</button>
    </div>
    <div id="tokenList" class="token-list"></div>

    <hr style="border:none;height:1px;background:rgba(255,255,255,0.02);margin:12px 0">

    <h3>Initiative Tracker</h3>
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <select id="initSelect"></select>
      <button id="addToInitiative">Add</button>
      <button id="rollInit">Roll All</button>
    </div>
    <div id="initiative" class="initiative">
      <div class="initiative-list" id="initiativeList"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="nextTurn">Next</button>
        <button id="clearInitiative">Clear</button>
      </div>
    </div>

    <hr style="border:none;height:1px;background:rgba(255,255,255,0.02);margin:12px 0">

    <h3>Dice Roller</h3>
    <div class="dice">
      <input id="diceInput" placeholder="e.g. 2d6+3" style="flex:1">
      <button id="rollBtn">Roll</button>
    </div>
    <div id="diceOutput" class="footer-hint" style="margin-top:8px"></div>

    <div class="footer-hint">Saved locally in this browser. Export to back up.</div>
  </aside>
</div>

<script>
/* ========== Simple DnD Studio App ==========

 Data model (saved in localStorage under key 'lk_dnd_studio_v1'):
 {
  characters: {id: {...}},
  tokens: {id: {...}},
  maps: {id: {...}},
  activeMapId: 'map-1',
  initiative: [{id, name, init, tokenId}]
 }

 Features implemented:
 - Character CRUD + import/export
 - Token CRUD + place tokens on a grid and drag with keyboard/ mouse
 - Map grid creation + paint tiles + undo
 - Initiative tracker with rolling
 - Dice roller (NdM+K)
 - Export/Import full campaign JSON
 - Auto-save to localStorage
*/

const STORAGE_KEY = 'lk_dnd_studio_v1';

let state = {
  characters: {}, // id -> char
  tokens: {}, // id -> token meta
  maps: {}, // id -> {w,h,tiles:[], tokensOnMap: [{id,tokenId,x,y,hp}]}
  activeMapId: null,
  initiative: [] // array of {id, name, init, tokenId}
};

const dom = {
  charList: document.getElementById('charList'),
  newChar: document.getElementById('newChar'),
  importChar: document.getElementById('importChar'),
  charEditor: document.getElementById('charEditor'),
  charName: document.getElementById('charName'),
  charAvatar: document.getElementById('charAvatar'),
  charHP: document.getElementById('charHP'),
  charAC: document.getElementById('charAC'),
  charStats: document.getElementById('charStats'),
  charNotes: document.getElementById('charNotes'),
  saveChar: document.getElementById('saveChar'),
  deleteChar: document.getElementById('deleteChar'),
  exportChar: document.getElementById('exportChar'),

  mapW: document.getElementById('mapW'),
  mapH: document.getElementById('mapH'),
  resizeMap: document.getElementById('resizeMap'),
  paintMode: document.getElementById('paintMode'),
  undoPaint: document.getElementById('undoPaint'),
  gridWrap: document.getElementById('gridWrap'),
  tokenPicker: document.getElementById('tokenPicker'),
  newTokenBtn: document.getElementById('newToken'),
  tokenList: document.getElementById('tokenList'),
  addTokenBtn: document.getElementById('addTokenBtn'),
  createTokenBtn: document.getElementById('createTokenBtn'),
  exportMap: document.getElementById('exportMap'),
  importMap: document.getElementById('importMap'),
  importMapFile: document.getElementById('importMapFile'),

  exportCampaign: document.getElementById('exportCampaign'),
  importCampaign: document.getElementById('importCampaign'),
  importFile: document.getElementById('importFile'),
  clearAll: document.getElementById('clearAll'),

  initSelect: document.getElementById('initSelect'),
  addToInitiative: document.getElementById('addToInitiative'),
  initiativeList: document.getElementById('initiativeList'),
  rollInit: document.getElementById('rollInit'),
  nextTurn: document.getElementById('nextTurn'),
  clearInitiative: document.getElementById('clearInitiative'),

  diceInput: document.getElementById('diceInput'),
  rollBtn: document.getElementById('rollBtn'),
  diceOutput: document.getElementById('diceOutput')
};

// ---------- utilities ----------
function uid(prefix='id'){return prefix + '-' + Math.random().toString(36).slice(2,9)}
function saveState(){localStorage.setItem(STORAGE_KEY, JSON.stringify(state))}
function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(raw) {
    try { state = JSON.parse(raw); } catch(e){ console.warn('failed read state',e) }
  } else {
    // create default map
    const mapId = uid('map');
    state.maps[mapId] = {id:mapId,w:12,h:8,tiles:Array(12*8).fill('floor'), tokensOnMap:[]};
    state.activeMapId = mapId;
    saveState();
  }
}
function downloadJSON(obj, filename='export.json'){
  const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}
function readFileInput(file, cb){
  const reader = new FileReader();
  reader.onload = e => {
    try{ cb(JSON.parse(e.target.result)) } catch(err){ alert('Invalid JSON file') }
  };
  reader.readAsText(file);
}
function rollDice(expression){
  // simple NdM+K parser
  const m = expression.trim().match(/^(\d*)d(\d+)([+-]\d+)?$/i);
  if(!m) return null;
  const n = parseInt(m[1]||'1',10);
  const s = parseInt(m[2],10);
  const mod = parseInt(m[3]||'0',10);
  const rolls = [];
  let total = 0;
  for(let i=0;i<n;i++){ const r = Math.floor(Math.random()*s)+1; rolls.push(r); total+=r }
  return {n,s,mod,rolls,total,final: total+mod};
}

// ---------- initialize ----------

loadState(); renderAll();

// ---------- Characters UI ----------
let editingCharId = null;

dom.newChar.addEventListener('click', ()=>{
  const id = uid('char');
  state.characters[id] = {id,name:'New Character',avatar:'👤',hp:10,ac:10,stats:[10,10,10,10,10,10],notes:''};
  editingCharId = id;
  saveState(); renderChars(); openCharEditor(id);
});

dom.importChar.addEventListener('click', ()=>{
  const input = document.createElement('input'); input.type='file'; input.accept='.json';
  input.onchange = (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    readFileInput(file, data=>{
      // expect single character object or map of characters
      if(Array.isArray(data)){ data.forEach(c=>state.characters[c.id||uid('char')]=c) }
      else if(data.id && data.name) state.characters[data.id||uid('char')] = data;
      else if(typeof data === 'object'){ Object.assign(state.characters, data) }
      saveState(); renderChars();
    });
  };
  input.click();
});

function renderChars(){
  dom.charList.innerHTML='';
  const arr = Object.values(state.characters);
  arr.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  arr.forEach(ch=>{
    const el = document.createElement('div'); el.className='char-item';
    el.dataset.id = ch.id;
    el.innerHTML = `<div class="avatar">${ch.avatar||'👤'}</div>
      <div class="char-meta"><div style="font-weight:700">${ch.name}</div><div class="small">HP ${ch.hp} • AC ${ch.ac}</div></div>`;
    el.onclick = ()=> openCharEditor(ch.id);
    dom.charList.appendChild(el);
  });

  // update init select
  dom.initSelect.innerHTML = '';
  Object.values(state.characters).forEach(ch=>{
    const o = document.createElement('option'); o.value = ch.id; o.textContent = ch.name; dom.initSelect.appendChild(o)
  });
}
function openCharEditor(id){
  const ch = state.characters[id];
  if(!ch) return;
  editingCharId = id;
  dom.charEditor.style.display='block';
  dom.charName.value = ch.name; dom.charAvatar.value = ch.avatar||'';
  dom.charHP.value = ch.hp; dom.charAC.value = ch.ac;
  dom.charStats.value = (ch.stats||[]).join(',');
  dom.charNotes.value = ch.notes||'';
  // highlight selected in list
  Array.from(dom.charList.children).forEach(node=>node.classList.toggle('active', node.dataset.id===id));
}
dom.saveChar.addEventListener('click', ()=>{
  if(!editingCharId) return;
  const ch = state.characters[editingCharId];
  ch.name = dom.charName.value || ch.name;
  ch.avatar = dom.charAvatar.value || ch.avatar;
  ch.hp = Number(dom.charHP.value)||0;
  ch.ac = Number(dom.charAC.value)||0;
  ch.stats = dom.charStats.value.split(',').map(s=>Number(s.trim())||0);
  ch.notes = dom.charNotes.value;
  state.characters[editingCharId] = ch;
  saveState(); renderChars();
});
dom.deleteChar.addEventListener('click', ()=>{
  if(!editingCharId) return;
  if(!confirm('Delete character?')) return;
  delete state.characters[editingCharId];
  editingCharId = null; dom.charEditor.style.display='none';
  saveState(); renderChars();
});
dom.exportChar.addEventListener('click', ()=>{
  if(!editingCharId) return alert('Open a character to export');
  const ch = state.characters[editingCharId];
  downloadJSON(ch, `${(ch.name||'character').replace(/\s+/g,'_')}.json`);
});

// ---------- Tokens ----------
function renderTokens(){
  dom.tokenList.innerHTML=''; dom.tokenPicker.innerHTML='';
  Object.values(state.tokens).forEach(t=>{
    const el = document.createElement('div'); el.className='token-item';
    el.innerHTML = `<div class="avatar">${t.icon||'⚪'}</div><div style="flex:1"><div style="font-weight:700">${t.name}</div><div class="small">HP ${t.hp||''}</div></div>
      <div style="display:flex;flex-direction:column;gap:6px"><button data-id="${t.id}" class="placeBtn">Place</button><button data-id="${t.id}" class="delTok">Del</button></div>`;
    dom.tokenList.appendChild(el);

    const o = document.createElement('option'); o.value = t.id; o.textContent = t.name; dom.tokenPicker.appendChild(o);
  });

  // attach handlers
  Array.from(document.querySelectorAll('.placeBtn')).forEach(b=>{
    b.onclick = e=> { const id = e.target.dataset.id; currentPaintToken = id; alert('Token selected for placement. Click a tile to place the token.') }
  });
  Array.from(document.querySelectorAll('.delTok')).forEach(b=>{
    b.onclick = e=>{ const id = e.target.dataset.id; if(confirm('Delete token?')){ delete state.tokens[id]; saveState(); renderTokens(); renderGrid(); } }
  });
}

dom.newToken.addEventListener('click', ()=>{
  const id = uid('tok');
  state.tokens[id] = {id,name:'New Token',icon:'🟢',hp:10};
  saveState(); renderTokens();
});

dom.createTokenBtn.addEventListener('click', ()=>{
  const name = prompt('Token name:') || 'Token';
  const icon = prompt('Emoji or single char for icon (e.g. ⚔️):') || '🔸';
  const hp = Number(prompt('HP (optional):', '10') || 10);
  const id = uid('tok');
  state.tokens[id] = {id,name,icon,hp};
  saveState(); renderTokens();
});

dom.addTokenBtn.addEventListener('click', ()=>{
  const tokId = dom.tokenPicker.value;
  if(!tokId) return alert('Select a token from the picker');
  // enable placement tool
  currentPaintToken = tokId;
  alert('Token selected for placement. Click tile to place.');
});

// ---------- Map editor ----------
let paintUndoStack = [];
let currentPaintToken = null; // token id to place when clicking tile
let selectedTileIndex = null;
let draggingToken = null;

dom.resizeMap.addEventListener('click', ()=>{
  const w = Number(dom.mapW.value), h = Number(dom.mapH.value);
  if(!w||!h) return alert('Invalid size');
  const map = state.maps[state.activeMapId];
  const newTiles = Array(w*h).fill('floor');
  // copy old into top-left
  for(let y=0;y<Math.min(h,map.h);y++){
    for(let x=0;x<Math.min(w,map.w);x++){
      newTiles[y*w + x] = map.tiles[y*map.w + x]||'floor';
    }
  }
  map.w=w; map.h=h; map.tiles=newTiles;
  saveState(); renderGrid();
});

dom.paintMode.addEventListener('change', ()=>{ currentPaintToken = null });

dom.undoPaint.addEventListener('click', ()=>{
  const map = state.maps[state.activeMapId];
  const last = paintUndoStack.pop();
  if(!last) return;
  map.tiles[last.idx] = last.prev;
  saveState(); renderGrid();
});

dom.exportMap.addEventListener('click', ()=>{
  const map = state.maps[state.activeMapId];
  downloadJSON(map, (map.id||'map') + '.map.json');
});
dom.importMap.addEventListener('click', ()=> dom.importMapFile.click());
dom.importMapFile.addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return;
  readFileInput(f, data=>{
    if(data.id) state.maps[data.id] = data;
    else alert('Invalid map file');
    saveState(); renderAll();
  });
});

function renderGrid(){
  const map = state.maps[state.activeMapId];
  dom.gridWrap.innerHTML = '';
  dom.gridWrap.style.gridTemplateColumns = `repeat(${map.w}, 1fr)`;
  dom.gridWrap.style.width = `${map.w * 50}px`;
  dom.gridWrap.style.height = `${map.h * 50}px`;

  // create tile elements
  for(let y=0;y<map.h;y++){
    for(let x=0;x<map.w;x++){
      const idx = y*map.w + x;
      const tileType = map.tiles[idx] || 'floor';
      const el = document.createElement('div');
      el.className = 'tile';
      if((x+y)%2) el.classList.add('alt');
      el.dataset.idx = idx; el.dataset.x=x; el.dataset.y=y;
      // tile content: emoji or small marker based on type
      const icon = tileType==='floor' ? '' : tileType==='wall' ? '▣' : tileType==='water' ? '≈' : '';
      el.textContent = icon;
      el.title = `${tileType} (${x},${y})`;
      el.style.width = '48px'; el.style.height='48px';
      // token on this tile?
      const tokOn = map.tokensOnMap.find(t=>t.x===x && t.y===y);
      if(tokOn) {
        el.innerHTML = `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center">
          <div style="font-size:18px">${state.tokens[tokOn.tokenId]?.icon||'🔸'}</div>
          <div style="font-size:11px">${tokOn.name}</div>
        </div>`;
        el.classList.add('token-present');
      }

      el.addEventListener('click', tileClick);
      el.addEventListener('dblclick', tileDblClick);
      dom.gridWrap.appendChild(el);
    }
  }
  // keyboard support for moving selected token
  dom.gridWrap.focus();
}

function tileClick(e){
  const idx = Number(e.currentTarget.dataset.idx);
  const map = state.maps[state.activeMapId];
  const mode = dom.paintMode.value;

  // if a token is selected for placement
  if(currentPaintToken){
    // place token on clicked tile (if no token already)
    const x = Number(e.currentTarget.dataset.x), y = Number(e.currentTarget.dataset.y);
    const existing = map.tokensOnMap.find(t=>t.x===x && t.y===y);
    if(existing) {
      if(!confirm('Replace token on this tile?')) return;
      map.tokensOnMap = map.tokensOnMap.filter(t=>!(t.x===x && t.y===y));
    }
    const tok = state.tokens[currentPaintToken];
    const placed = {id:uid('placed'), tokenId:currentPaintToken, name:tok.name, x, y, hp:tok.hp||0};
    map.tokensOnMap.push(placed);
    currentPaintToken = null;
    saveState(); renderGrid();
    return;
  }

  // otherwise painting
  if(mode && mode !== 'erase'){
    const prev = map.tiles[idx];
    paintUndoStack.push({idx, prev});
    map.tiles[idx] = mode;
    saveState(); renderGrid(); return;
  } else if(mode === 'erase'){
    const prev = map.tiles[idx];
    paintUndoStack.push({idx, prev});
    map.tiles[idx] = 'floor';
    saveState(); renderGrid(); return;
  }

  // selecting tokens on tile (single-click)
  const x = Number(e.currentTarget.dataset.x), y = Number(e.currentTarget.dataset.y);
  const placed = map.tokensOnMap.find(t=>t.x===x && t.y===y);
  if(placed){
    // open quick context: move or delete or edit hp
    const action = prompt(`Token: ${placed.name}\n type "move" to pick up, "del" to delete, or new HP to set`, 'move');
    if(action === null) return;
    if(action==='move'){
      draggingToken = placed; // next click on tile will move it
      alert('Click on target tile to move token.');
      return;
    } else if(action === 'del'){
      map.tokensOnMap = map.tokensOnMap.filter(t=>t.id !== placed.id);
      saveState(); renderGrid(); return;
    } else {
      const hp = Number(action); if(!isNaN(hp)) placed.hp = hp; saveState(); renderGrid(); return;
    }
  }

  // move token if dragging
  if(draggingToken){
    const placed = draggingToken;
    placed.x = x; placed.y = y; draggingToken = null;
    saveState(); renderGrid(); return;
  }
}

function tileDblClick(e){
  // quick paint toggle among floor/wall/water
  const idx = Number(e.currentTarget.dataset.idx), map = state.maps[state.activeMapId];
  const cur = map.tiles[idx];
  const order = ['floor','wall','water'];
  const next = order[(order.indexOf(cur)+1) % order.length];
  paintUndoStack.push({idx, prev:cur});
  map.tiles[idx] = next; saveState(); renderGrid();
}

function renderAll(){
  renderChars(); renderTokens();
  // ensure an active map exists
  if(!state.activeMapId || !state.maps[state.activeMapId]){
    const id = Object.keys(state.maps)[0]; state.activeMapId = id;
  }
  dom.mapW.value = state.maps[state.activeMapId].w;
  dom.mapH.value = state.maps[state.activeMapId].h;
  renderGrid(); renderInitiative();
  saveState();
}

// ---------- Initiative ----------
dom.addToInitiative.addEventListener('click', ()=>{
  const charId = dom.initSelect.value;
  if(!charId) return alert('Select a character to add');
  const ch = state.characters[charId];
  const atk = Number(prompt('Manual init value? leave blank to roll', '')) ;
  const roll = isNaN(atk) ? (Math.floor(Math.random()*20)+1) : atk;
  state.initiative.push({id:uid('ini'), name:ch.name, init:roll, tokenId:null});
  saveState(); renderInitiative();
});

dom.rollInit.addEventListener('click', ()=>{
  // roll for all current initiative entries (if characters exist)
  state.initiative = [];
  Object.values(state.characters).forEach(ch=>{
    const roll = Math.floor(Math.random()*20)+1 + 0; // no dex mod by default
    state.initiative.push({id:uid('ini'), name:ch.name, init:roll, tokenId:null});
  });
  saveState(); renderInitiative();
});

function renderInitiative(){
  dom.initiativeList.innerHTML='';
  state.initiative.sort((a,b)=>b.init - a.init);
  state.initiative.forEach((it, idx)=>{
    const el = document.createElement('div'); el.className='initiative-item';
    el.innerHTML = `<div><strong>${it.name}</strong> <span style="color:#aaa">(${it.init})</span></div>
      <div style="display:flex;gap:8px"><button data-id="${it.id}" class="iniUp">▲</button><button data-id="${it.id}" class="iniDown">▼</button><button data-id="${it.id}" class="iniDel">✖</button></div>`;
    dom.initiativeList.appendChild(el);
  });
  // attach buttons
  Array.from(document.querySelectorAll('.iniUp')).forEach(b=>b.onclick = e=>{
    const id = e.target.dataset.id; const idx = state.initiative.findIndex(x=>x.id===id);
    if(idx>0){ const tmp = state.initiative[idx-1]; state.initiative[idx-1]=state.initiative[idx]; state.initiative[idx]=tmp; saveState(); renderInitiative() }
  });
  Array.from(document.querySelectorAll('.iniDown')).forEach(b=>b.onclick = e=>{
    const id = e.target.dataset.id; const idx = state.initiative.findIndex(x=>x.id===id);
    if(idx < state.initiative.length-1){ const tmp = state.initiative[idx+1]; state.initiative[idx+1]=state.initiative[idx]; state.initiative[idx]=tmp; saveState(); renderInitiative() }
  });
  Array.from(document.querySelectorAll('.iniDel')).forEach(b=>b.onclick = e=>{
    const id = e.target.dataset.id; state.initiative = state.initiative.filter(x=>x.id!==id); saveState(); renderInitiative();
  });
}

dom.nextTurn.addEventListener('click', ()=>{
  if(state.initiative.length===0) return;
  // rotate first entry to end
  const first = state.initiative.shift();
  state.initiative.push(first);
  saveState(); renderInitiative();
});
dom.clearInitiative.addEventListener('click', ()=>{ if(confirm('Clear initiative?')){ state.initiative=[]; saveState(); renderInitiative() } });

// ---------- Dice roller ----------
dom.rollBtn.addEventListener('click', ()=>{
  const expr = dom.diceInput.value.trim();
  if(!expr) return;
  const res = rollDice(expr);
  if(!res) { dom.diceOutput.textContent='Invalid expression. Use NdM+K (e.g. 2d6+3)'; return; }
  dom.diceOutput.textContent = `Rolls: ${res.rolls.join(', ')} | total: ${res.total} | mod: ${res.mod} -> final: ${res.final}`;
});

// ---------- Campaign export/import ----------
dom.exportCampaign.addEventListener('click', ()=>{
  downloadJSON(state, 'lk_dnd_campaign.json');
});
dom.importCampaign.addEventListener('click', ()=> dom.importFile.click());
dom.importFile.addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return;
  readFileInput(f, data=>{
    if(!data) return alert('Bad file');
    if(confirm('Importing will overwrite current local campaign. Continue?')){
      state = data; saveState(); renderAll();
    }
  });
});

dom.clearAll.addEventListener('click', ()=>{
  if(confirm('Reset everything and clear local storage?')){ localStorage.removeItem(STORAGE_KEY); location.reload(); }
});

// ---------- Map token move with arrow keys ----------
document.addEventListener('keydown', (e)=>{
  const map = state.maps[state.activeMapId];
  if(!map) return;
  // find selected token (if any token placed and one is marked as selected token id stored in draggingToken)
  // For convenience: use arrow keys to move last placed token
  if(e.key.startsWith('Arrow')){
    e.preventDefault();
    const last = map.tokensOnMap[map.tokensOnMap.length-1];
    if(!last) return;
    if(e.key==='ArrowLeft') last.x = Math.max(0, last.x -1);
    if(e.key==='ArrowRight') last.x = Math.min(map.w-1, last.x +1);
    if(e.key==='ArrowUp') last.y = Math.max(0, last.y -1);
    if(e.key==='ArrowDown') last.y = Math.min(map.h-1, last.y +1);
    saveState(); renderGrid();
  }
});

// ---------- Misc: initial sample data (if none) ----------
(function seedIfEmpty(){
  if(Object.keys(state.characters).length===0){
    const c1 = uid('char'); state.characters[c1] = {id:c1,name:'Ren Morikawa',avatar:'😺',hp:18,ac:13,stats:[12,14,12,10,11,9],notes:'Protagonist — exchange student.'};
    const c2 = uid('char'); state.characters[c2] = {id:c2,name:'Talia',avatar:'🪄',hp:12,ac:12,stats:[8,16,10,14,12,11],notes:'Arcane thief.'};
  }
  if(Object.keys(state.tokens).length===0){
    const t1 = uid('tok'); state.tokens[t1] = {id:t1,name:'Goblin',icon:'👹',hp:7};
    const t2 = uid('tok'); state.tokens[t2] = {id:t2,name:'Owlbear',icon:'🦉',hp:42};
  }
  saveState();
})();

renderAll();

/* ========== End script ========== */
</script>
</body>
</html>
